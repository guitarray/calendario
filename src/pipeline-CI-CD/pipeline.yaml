apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: calendario-pipeline
  namespace: raimondopd-dev
spec:
  params:
    - name: git-url
      type: string
      default: https://github.com/guitarray/calendario.git
    - name: git-revision
      type: string
      default: main
    - name: image-url
      type: string
      default: image-registry.openshift-image-registry.svc:5000/raimondopd-dev/calendario:latest

  workspaces:
    - name: shared-workspace

  tasks:
    # 1Ô∏è‚É£ Clone del repository con debug e fallback su master
    - name: clone
      taskSpec:
        workspaces:
          - name: output
        params:
          - name: url
            type: string
          - name: revision
            type: string
        steps:
          - name: git-clone
            image: alpine/git
            workingDir: /workspace/output
            script: |
              echo "üîÑ Clonazione repository $(params.url) (branch $(params.revision))"
              rm -rf /workspace/output/*
              set -e
              echo "üîé Verifico se il branch $(params.revision) esiste..."
              if git ls-remote --heads $(params.url) $(params.revision) | grep $(params.revision); then
                echo "‚úÖ Branch trovato, eseguo clone..."
                git clone -b $(params.revision) $(params.url) /workspace/output
              else
                echo "‚ö†Ô∏è Branch $(params.revision) non trovato, provo con 'master'..."
                git clone -b master $(params.url) /workspace/output
              fi
              echo "üìÇ Contenuto dopo il clone:"
              ls -la /workspace/output
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: output
          workspace: shared-workspace

    # 2Ô∏è‚É£ Installazione dipendenze e build
    - name: npm-build
      runAfter:
        - clone
      taskSpec:
        workspaces:
          - name: output
        steps:
          - name: install
            image: node:20
            workingDir: /workspace/output
            script: |
              echo "üìÇ Contenuto della cartella:"
              ls -la
              if [ ! -f package.json ]; then
                echo "‚ùå ERRORE: package.json non trovato!"
                exit 1
              fi
              echo "üì¶ Installazione dipendenze..."
              npm install
              echo "üèóÔ∏è Build del progetto..."
              npm run build || echo "‚ö†Ô∏è Build fallita, ma continuiamo..."
              npm test || echo "‚ö†Ô∏è Test falliti, ma continuiamo..."
      workspaces:
        - name: output
          workspace: shared-workspace

    # 3Ô∏è‚É£ Analisi SonarCloud
    - name: sonar-analysis
      runAfter:
        - npm-build
      taskSpec:
        workspaces:
          - name: output
        steps:
          - name: sonar
            image: sonarsource/sonar-scanner-cli:latest
            workingDir: /workspace/output
            script: |
              echo "üîé Avvio analisi SonarCloud..."
              sonar-scanner \
                -Dsonar.projectKey=calendario \
                -Dsonar.sources=. \
                -Dsonar.host.url=https://sonarcloud.io \
                -Dsonar.login=$(SONAR_TOKEN)
            env:
              - name: SONAR_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: sonar-secret
                    key: token
      workspaces:
        - name: output
          workspace: shared-workspace

    # 4Ô∏è‚É£ Build immagine container con Buildah
    - name: build-image
      runAfter:
        - sonar-analysis
      taskRef:
        name: buildah
      params:
        - name: IMAGE
          value: $(params.image-url)
        - name: CONTEXT
          value: /workspace/output
        - name: FORMAT
          value: docker
        - name: TLSVERIFY
          value: "false"
      workspaces:
        - name: source
          workspace: shared-workspace

    # 5Ô∏è‚É£ Deploy su OpenShift
    - name: deploy
      runAfter:
        - build-image
      taskSpec:
        steps:
          - name: oc-deploy
            image: quay.io/openshift/origin-cli:latest
            script: |
              echo "üöÄ Deploy dell'applicazione calendario..."
              oc apply -f deployment.yaml
              oc rollout restart deployment/calendario
