apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: calendario-pipeline
  namespace: raimondopd-dev
spec:
  params:
    - name: git-url
      type: string
      default: https://github.com/guitarray/calendario.git
    - name: git-revision
      type: string
      default: main
    - name: image-url
      type: string
      default: image-registry.openshift-image-registry.svc:5000/raimondopd-dev/calendario:latest

  workspaces:
    - name: shared-workspace

  tasks:
    - name: clone
      taskSpec:
        workspaces:
          - name: output
        params:
          - name: url
            type: string
          - name: revision
            type: string
        steps:
          - name: git-clone
            image: alpine/git
            workingDir: /workspace/output
            script: |
              echo "üîÑ Cloning repository $(params.url) (branch $(params.revision))"
              rm -rf /workspace/output/*
              git clone -b $(params.revision) $(params.url) /workspace/output
              echo "‚úÖ Clone completed"
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: $(params.git-revision)
      workspaces:
        - name: output
          workspace: shared-workspace

    - name: npm-build
      runAfter:
        - clone
      taskSpec:
        workspaces:
          - name: output
        steps:
          - name: install
            image: node:20
            workingDir: /workspace/output
            script: |
              echo "üìÇ Contenuto della cartella:"
              ls -la
              if [ ! -f package.json ]; then
                echo "‚ùå ERRORE: package.json non trovato!"
                exit 1
              fi
              echo "üì¶ Installazione dipend
